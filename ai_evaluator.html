<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assignment Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">AI Assignment Evaluator</h1>
            <p class="text-gray-600">Upload student submission zip files for automated evaluation</p>
            <div class="mt-4 flex gap-3">
                <a href="/playground.html" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i data-lucide="gamepad-2" class="w-4 h-4 inline mr-2"></i>
                    AI Playground
                </a>
                <button id="settings-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i>
                    Scoring Settings
                </button>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üéØ Scoring Weights Configuration</h3>
                <p class="text-gray-600 mb-4">Adjust how different components contribute to the final score (must sum to 100%)</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Functional Tests</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="functional-weight" min="0" max="1" step="0.05" value="0.4" class="flex-1">
                            <span id="functional-value" class="text-sm font-medium text-blue-600 w-12">40%</span>
                        </div>
                        <p class="text-xs text-gray-500">Test cases passed (static analysis)</p>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Code Quality</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="code-quality-weight" min="0" max="1" step="0.05" value="0.4" class="flex-1">
                            <span id="code-quality-value" class="text-sm font-medium text-blue-600 w-12">40%</span>
                        </div>
                        <p class="text-xs text-gray-500">AI-assessed code quality</p>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Report Quality</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="report-quality-weight" min="0" max="1" step="0.05" value="0.2" class="flex-1">
                            <span id="report-value" class="text-sm font-medium text-blue-600 w-12">20%</span>
                        </div>
                        <p class="text-xs text-gray-500">AI-assessed report quality</p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-blue-800">Total Weight:</span>
                        <span id="total-weight" class="text-lg font-bold text-blue-600">100%</span>
                    </div>
                    <div id="weight-warning" class="text-sm text-red-600 mt-2 hidden">
                        ‚ö†Ô∏è Weights must sum to 100%
                    </div>
                </div>
            </div>

            <!-- Starter Code Configuration -->
            <div class="border-t border-gray-200 pt-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìù Starter Code Exclusion</h3>
                <p class="text-gray-600 mb-4">Upload or paste starter code that should be ignored during plagiarism detection</p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Starter Code File</label>
                        <div class="flex items-center space-x-4">
                            <input type="file" id="starter-code-file" accept=".py,.txt,.md" class="hidden">
                            <button onclick="document.getElementById('starter-code-file').click()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                                Choose File
                            </button>
                            <span id="starter-file-name" class="text-sm text-gray-600">No file selected</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Supported formats: .py, .txt, .md</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Or Paste Starter Code</label>
                        <textarea id="starter-code-text" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm" placeholder="Paste your starter code here..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">Code will be normalized and excluded from plagiarism analysis</p>
                    </div>

                    <div id="starter-code-preview" class="hidden">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-gray-700">Starter Code Preview</span>
                                <button onclick="clearStarterCode()" class="text-red-600 hover:text-red-800 text-sm">
                                    <i data-lucide="x" class="w-4 h-4 inline mr-1"></i>
                                    Clear
                                </button>
                            </div>
                            <pre id="starter-code-content" class="text-xs text-gray-800 whitespace-pre-wrap font-mono bg-white p-2 rounded border max-h-40 overflow-y-auto"></pre>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex space-x-4">
                <button id="save-settings" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors disabled:opacity-50">
                    Save Settings
                </button>
                <button id="reset-settings" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                    Reset to Default
                </button>
                <button id="close-settings" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>

        <!-- Upload Section -->
        <div id="upload-container" class="bg-white rounded-lg shadow-md p-8 mb-8">
            <!-- Upload Mode Toggle -->
            <div class="mb-6">
                <div class="flex items-center justify-center space-x-4">
                    <span class="text-sm font-medium text-gray-700">Upload Mode:</span>
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button id="individual-mode" class="px-4 py-2 text-sm font-medium rounded-md transition-colors bg-white text-blue-600 shadow-sm">
                            Individual Files
                        </button>
                        <button id="batch-mode" class="px-4 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800">
                            Batch Upload
                        </button>
                    </div>
                </div>
            </div>

            <!-- Individual Files Upload -->
            <div id="individual-upload" class="block">
                <div id="upload-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-blue-400 transition-colors cursor-pointer">
                    <div class="mb-4">
                        <i data-lucide="upload-cloud" class="w-16 h-16 text-gray-400 mx-auto"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Drop individual zip files here</h3>
                    <p class="text-gray-500 mb-4">Upload multiple student submissions separately</p>
                    <input type="file" id="file-input" multiple accept=".zip" class="hidden">
                    <button id="browse-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                        Browse Files
                    </button>
                </div>

                <!-- File List -->
                <div id="file-list" class="mt-6 hidden">
                    <h4 class="font-semibold text-gray-700 mb-3">Selected Files:</h4>
                    <div id="file-items" class="space-y-2"></div>
                </div>
            </div>

            <!-- Batch Upload -->
            <div id="batch-upload" class="hidden">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-purple-400 transition-colors cursor-pointer">
                    <div class="mb-4">
                        <i data-lucide="archive" class="w-16 h-16 text-gray-400 mx-auto"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Drop batch zip file here</h3>
                    <p class="text-gray-500 mb-4">Upload a single zip containing all student submissions</p>
                    <input type="file" id="batch-input" accept=".zip" class="hidden">
                    <button id="batch-browse-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg transition-colors">
                        Browse Batch File
                    </button>
                </div>

                <!-- Batch File Info -->
                <div id="batch-info" class="mt-6 hidden">
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <i data-lucide="info" class="w-5 h-5 text-purple-500 mr-2"></i>
                            <span class="text-purple-700 font-medium">Batch file selected:</span>
                        </div>
                        <p id="batch-filename" class="text-purple-600 text-sm mt-1"></p>
                        <p class="text-purple-500 text-xs mt-2">This will process all student submissions found in the zip file.</p>
                    </div>
                </div>
            </div>

            <!-- Upload Button -->
            <div class="text-center mt-6">
                <button id="upload-btn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Start Evaluation
                </button>
            </div>
        </div>

        <!-- Loading Section -->
        <div id="loading-spinner" class="bg-white rounded-lg shadow-md p-8 mb-8 hidden">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Evaluating Submissions...</h3>
                <p id="status-text" class="text-gray-600">Preparing evaluation environment</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <i data-lucide="users" class="w-8 h-8 text-blue-500 mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Total Submissions</p>
                            <p id="total-submissions" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Avg Test Cases</p>
                            <p id="avg-functional" class="text-2xl font-bold text-gray-800">0.00</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <i data-lucide="code" class="w-8 h-8 text-blue-500 mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Avg Code Quality</p>
                            <p id="avg-code-quality" class="text-2xl font-bold text-gray-800">0.00</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <i data-lucide="file-text" class="w-8 h-8 text-purple-500 mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Avg Report Quality</p>
                            <p id="avg-report" class="text-2xl font-bold text-gray-800">0.00</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <i data-lucide="alert-triangle" class="w-8 h-8 text-red-500 mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Avg Plagiarism</p>
                            <p id="avg-plagiarism" class="text-2xl font-bold text-gray-800">0.00</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overview Table -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">üìä Evaluation Overview</h3>
                    <div class="flex space-x-3">
                        <button id="export-csv" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                            Export CSV
                        </button>
                        <button id="export-json" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            <i data-lucide="file-json" class="w-4 h-4 inline mr-2"></i>
                            Export JSON
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Student ID</th>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Test Cases</th>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Code Quality</th>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Report Quality</th>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Overall Score</th>
                                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Plagiarism</th>
                            </tr>
                        </thead>
                        <tbody id="overview-table-body">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Detailed Student Reports -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">üìã Detailed Analysis</h3>
                <div id="student-reports" class="space-y-6"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let batchFile = null;
        let uploadMode = 'individual'; // 'individual' or 'batch'
        let pollingInterval = null;
        let currentJobId = null;

        // Initialize Lucide icons
        lucide.createIcons();

        // DOM elements
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const fileList = document.getElementById('file-list');
        const fileItems = document.getElementById('file-items');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusText = document.getElementById('status-text');
        const resultsContainer = document.getElementById('results-container');
        const uploadContainer = document.getElementById('upload-container');

        // Batch upload elements
        const batchUpload = document.getElementById('batch-upload');
        const batchInput = document.getElementById('batch-input');
        const batchBrowseBtn = document.getElementById('batch-browse-btn');
        const batchInfo = document.getElementById('batch-info');
        const batchFilename = document.getElementById('batch-filename');

        // Mode toggle elements
        const individualMode = document.getElementById('individual-mode');
        const batchMode = document.getElementById('batch-mode');

        // Settings elements
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const functionalWeight = document.getElementById('functional-weight');
        const codeQualityWeight = document.getElementById('code-quality-weight');
        const reportQualityWeight = document.getElementById('report-quality-weight');
        const functionalValue = document.getElementById('functional-value');
        const codeQualityValue = document.getElementById('code-quality-value');
        const reportValue = document.getElementById('report-value');
        const totalWeight = document.getElementById('total-weight');
        const weightWarning = document.getElementById('weight-warning');
        const saveSettings = document.getElementById('save-settings');
        const resetSettings = document.getElementById('reset-settings');
        const closeSettings = document.getElementById('close-settings');

        // Starter code elements
        const starterCodeFile = document.getElementById('starter-code-file');
        const starterFileName = document.getElementById('starter-file-name');
        const starterCodeText = document.getElementById('starter-code-text');
        const starterCodePreview = document.getElementById('starter-code-preview');
        const starterCodeContent = document.getElementById('starter-code-content');

        // Export elements
        const exportCsv = document.getElementById('export-csv');
        const exportJson = document.getElementById('export-json');

        // Export event listeners
        exportCsv.addEventListener('click', () => exportData('csv'));
        exportJson.addEventListener('click', () => exportData('json'));

        // Mode switching
        individualMode.addEventListener('click', () => switchToIndividualMode());
        batchMode.addEventListener('click', () => switchToBatchMode());

        // Settings event listeners
        settingsBtn.addEventListener('click', toggleSettings);
        functionalWeight.addEventListener('input', updateWeightDisplay);
        codeQualityWeight.addEventListener('input', updateWeightDisplay);
        reportQualityWeight.addEventListener('input', updateWeightDisplay);
        saveSettings.addEventListener('click', saveSettingsToServer);
        resetSettings.addEventListener('click', resetSettingsToDefault);
        closeSettings.addEventListener('click', () => settingsPanel.classList.add('hidden'));

        // Starter code event listeners
        starterCodeFile.addEventListener('change', handleStarterCodeFile);
        starterCodeText.addEventListener('input', handleStarterCodeText);

        // Load current settings on page load
        loadCurrentSettings();

        // Event listeners
        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelection);
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadBtn.addEventListener('click', uploadFiles);

        // Batch upload listeners
        batchBrowseBtn.addEventListener('click', () => batchInput.click());
        batchInput.addEventListener('change', handleBatchSelection);

        // Drag and drop functionality
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('border-blue-500', 'bg-blue-50');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('border-blue-500', 'bg-blue-50');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        function switchToIndividualMode() {
            uploadMode = 'individual';
            individualMode.classList.remove('text-gray-600', 'hover:text-gray-800');
            individualMode.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
            batchMode.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
            batchMode.classList.add('text-gray-600', 'hover:text-gray-800');

            document.getElementById('individual-upload').classList.remove('hidden');
            batchUpload.classList.add('hidden');
            resetBatchSelection();
            updateUploadButton();
        }

        function switchToBatchMode() {
            uploadMode = 'batch';
            batchMode.classList.remove('text-gray-600', 'hover:text-gray-800');
            batchMode.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
            individualMode.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
            individualMode.classList.add('text-gray-600', 'hover:text-gray-800');

            batchUpload.classList.remove('hidden');
            document.getElementById('individual-upload').classList.add('hidden');
            resetFileSelection();
            updateUploadButton();
        }

        function handleFileSelection(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

        function handleBatchSelection(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                batchFile = files[0];
                batchFilename.textContent = batchFile.name + ` (${formatFileSize(batchFile.size)})`;
                batchInfo.classList.remove('hidden');
                updateUploadButton();
            }
        }

        function handleFiles(files) {
            selectedFiles = files.filter(file => file.name.endsWith('.zip'));
            updateFileList();
            updateUploadButton();
        }

        function updateFileList() {
            fileItems.innerHTML = '';
            if (selectedFiles.length > 0) {
                fileList.classList.remove('hidden');
                selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                    fileItem.innerHTML = `
                        <div class="flex items-center">
                            <i data-lucide="file" class="w-5 h-5 text-gray-500 mr-3"></i>
                            <span class="text-gray-700">${file.name}</span>
                            <span class="text-sm text-gray-500 ml-2">(${formatFileSize(file.size)})</span>
                        </div>
                        <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    `;
                    fileItems.appendChild(fileItem);
                });
                lucide.createIcons();
            } else {
                fileList.classList.add('hidden');
            }
        }

        function updateUploadButton() {
            if (uploadMode === 'individual') {
                uploadBtn.disabled = selectedFiles.length === 0;
                uploadBtn.textContent = selectedFiles.length > 0 ? 'Start Evaluation' : 'Select Files First';
            } else {
                uploadBtn.disabled = !batchFile;
                uploadBtn.textContent = batchFile ? 'Start Batch Evaluation' : 'Select Batch File First';
            }
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            updateUploadButton();
        }

        function resetFileSelection() {
            selectedFiles = [];
            fileList.classList.add('hidden');
            fileInput.value = '';
        }

        function resetBatchSelection() {
            batchFile = null;
            batchInfo.classList.add('hidden');
            batchInput.value = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function uploadFiles() {
            try {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';

                if (uploadMode === 'individual') {
                    if (selectedFiles.length === 0) return;

                    const formData = new FormData();
                    selectedFiles.forEach(file => {
                        formData.append('files', file);
                    });

                    const response = await fetch('http://127.0.0.1:5001/evaluate', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    currentJobId = data.job_id;

                    // Hide upload section and show loading
                    uploadContainer.classList.add('hidden');
                    loadingSpinner.classList.remove('hidden');

                    // Start polling for results
                    pollForResults(currentJobId);

                } else {
                    // Batch mode - first scan, then show submissions
                    if (!batchFile) return;

                    const formData = new FormData();
                    formData.append('batch', batchFile);

                    const response = await fetch('http://127.0.0.1:5001/evaluate/batch', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    currentJobId = data.job_id;

                    // Show submission list
                    showSubmissionList(data.submissions);

                    // Change button to start evaluation
                    uploadBtn.textContent = 'Start Batch Evaluation';
                    uploadBtn.onclick = startBatchEvaluation;
                    uploadBtn.disabled = false;
                }

            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
                uploadBtn.disabled = false;
                uploadBtn.textContent = uploadMode === 'individual' ? 'Start Evaluation' : 'Start Batch Evaluation';
            }
        }

        function showSubmissionList(submissions) {
            // Create submission list display
            const submissionList = document.createElement('div');
            submissionList.id = 'submission-list';
            submissionList.className = 'bg-white rounded-lg shadow-md p-6 mb-6';

            submissionList.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Found ${submissions.length} Submissions</h3>
                <div class="space-y-2 max-h-60 overflow-y-auto">
                    ${submissions.map(sub => `
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                            <div class="flex items-center">
                                <i data-lucide="user" class="w-5 h-5 text-blue-500 mr-3"></i>
                                <div>
                                    <span class="font-medium text-gray-800">${sub.student_id}</span>
                                    <span class="text-sm text-gray-500 ml-2">(${sub.filename})</span>
                                </div>
                            </div>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                ${sub.type || 'folder'}
                            </span>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-blue-800 text-sm">
                        <strong>Ready to evaluate!</strong> Click "Start Batch Evaluation" to begin processing all submissions.
                    </p>
                </div>
            `;

            // Insert after upload container
            uploadContainer.insertAdjacentElement('afterend', submissionList);
            lucide.createIcons();
        }

        async function startBatchEvaluation() {
            try {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Starting Evaluation...';

                const response = await fetch(`http://127.0.0.1:5001/evaluate/batch/start/${currentJobId}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Hide upload section and show loading
                uploadContainer.classList.add('hidden');
                document.getElementById('submission-list').classList.add('hidden');
                loadingSpinner.classList.remove('hidden');

                // Start polling for results
                pollForResults(currentJobId);

            } catch (error) {
                console.error('Batch start error:', error);
                alert('Failed to start batch evaluation: ' + error.message);
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Start Batch Evaluation';
            }
        }

        async function pollForResults(jobId) {
            try {
                const response = await fetch(`http://127.0.0.1:5001/evaluate/status/${jobId}`);
                const data = await response.json();

                if (data.status === 'processing') {
                    statusText.textContent = data.status_message || 'Processing...';
                    pollingInterval = setTimeout(() => pollForResults(jobId), 2000);
                } else if (data.status === 'complete') {
                    loadingSpinner.classList.add('hidden');
                    renderReport(data.report);
                } else if (data.status === 'failed') {
                    loadingSpinner.classList.add('hidden');
                    alert('Evaluation failed: ' + (data.status_message || 'Unknown error'));
                    resetUI();
                }
            } catch (error) {
                console.error('Polling error:', error);
                statusText.textContent = 'Connection error, retrying...';
                pollingInterval = setTimeout(() => pollForResults(jobId), 3000);
            }
        }

        function renderReport(report) {
            if (!report) return;

            // Update summary
            document.getElementById('total-submissions').textContent = report.summary.total_submissions;
            document.getElementById('avg-functional').textContent = (report.summary.average_functional_score * 100).toFixed(1) + '%';
            document.getElementById('avg-code-quality').textContent = (report.summary.average_code_quality_score * 100).toFixed(1) + '%';
            document.getElementById('avg-report').textContent = (report.summary.average_report_score * 100).toFixed(1) + '%';
            document.getElementById('avg-plagiarism').textContent = (report.summary.average_plagiarism_score * 100).toFixed(1) + '%';

            // Render overview table
            const tableBody = document.getElementById('overview-table-body');
            tableBody.innerHTML = '';

            // Render detailed student reports
            const studentReports = document.getElementById('student-reports');
            studentReports.innerHTML = '';

            report.student_reports.forEach(student => {
                const testCasesScore = (student.functional_score * 100).toFixed(1);
                const codeQualityScore = (student.code_quality_score * 100).toFixed(1);
                const reportScore = (student.report_score * 100).toFixed(1);
                const plagiarismScore = (student.plagiarism_score * 100).toFixed(1);

                // Calculate overall weighted score
                const overallScore = (student.functional_score * 0.4 + student.code_quality_score * 0.4 + student.report_score * 0.2) * 100;
                const overallScoreFormatted = overallScore.toFixed(1) + '%';

                // Add to overview table
                const tableRow = document.createElement('tr');
                tableRow.className = 'border-t border-gray-200';
                tableRow.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-800 font-medium">${student.student_id}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${parseFloat(testCasesScore) >= 80 ? 'bg-green-100 text-green-800' : parseFloat(testCasesScore) >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${testCasesScore}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${parseFloat(codeQualityScore) >= 80 ? 'bg-green-100 text-green-800' : parseFloat(codeQualityScore) >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${codeQualityScore}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${parseFloat(reportScore) >= 80 ? 'bg-green-100 text-green-800' : parseFloat(reportScore) >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${reportScore}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${overallScore >= 80 ? 'bg-green-100 text-green-800' : overallScore >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${overallScoreFormatted}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${parseFloat(plagiarismScore) <= 20 ? 'bg-green-100 text-green-800' : parseFloat(plagiarismScore) <= 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                ${plagiarismScore}%
                            </span>
                            ${student.plagiarism_details && student.plagiarism_details.length > 0 ? `
                                <button onclick="showPlagiarismDetails('${student.student_id}', '${btoa(JSON.stringify(student.plagiarism_details))}')" class="text-blue-500 hover:text-blue-700 text-xs">
                                    <i data-lucide="info" class="w-3 h-3"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tableBody.appendChild(tableRow);

                // Create detailed report card
                const reportCard = document.createElement('div');
                reportCard.className = 'border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow';

                reportCard.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h4 class="text-xl font-semibold text-gray-800">${student.student_id}</h4>
                            <p class="text-sm text-gray-600">${student.filename}</p>
                        </div>
                        <div class="text-right">
                            <div class="grid grid-cols-4 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-green-600">${testCasesScore}%</div>
                                    <div class="text-xs text-gray-500">Test Cases</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-blue-600">${codeQualityScore}%</div>
                                    <div class="text-xs text-gray-500">Code Quality</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-purple-600">${reportScore}%</div>
                                    <div class="text-xs text-gray-500">Report Quality</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold ${parseFloat(plagiarismScore) > 50 ? 'text-red-600' : 'text-yellow-600'}">${plagiarismScore}%</div>
                                    <div class="text-xs text-gray-500">Plagiarism</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analysis Section -->
                    <div class="mb-6">
                        <h5 class="font-medium text-gray-700 mb-3 flex items-center">
                            <i data-lucide="brain" class="w-5 h-5 mr-2"></i>
                            AI Analysis & Feedback
                        </h5>
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4">
                            <div class="prose prose-sm max-w-none text-gray-700">
                                ${formatAIFeedback(student.ai_feedback)}
                            </div>
                        </div>
                    </div>

                    <!-- Code Analysis Details -->
                    <div class="mb-6">
                        <h5 class="font-medium text-gray-700 mb-3 flex items-center">
                            <i data-lucide="code" class="w-5 h-5 mr-2"></i>
                            Code Analysis Breakdown
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h6 class="font-medium text-gray-800 mb-2">Test Cases & Implementation</h6>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Test Cases Passed:</span>
                                        <span class="font-medium">${getTestCasesStatus(student.functional_score)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Function Implementation:</span>
                                        <span class="font-medium">${getImplementationStatus(student.functional_score)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Algorithm Logic:</span>
                                        <span class="font-medium">${getAlgorithmStatus(student.functional_score)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h6 class="font-medium text-gray-800 mb-2">Code Quality (AI Analysis)</h6>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Code Structure:</span>
                                        <span class="font-medium">${getCodeQualityStatus(student.code_quality_score)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Best Practices:</span>
                                        <span class="font-medium">${getBestPracticesStatus(student.code_quality_score)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Readability:</span>
                                        <span class="font-medium">${getReadabilityStatus(student.code_quality_score)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Analysis Details -->
                    <div class="mb-6">
                        <h5 class="font-medium text-gray-700 mb-3 flex items-center">
                            <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                            Report Quality Analysis (AI Analysis)
                        </h5>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div class="flex justify-between">
                                    <span>Content Structure:</span>
                                    <span class="font-medium">${getReportStructureStatus(student.report_score)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Technical Depth:</span>
                                    <span class="font-medium">${getTechnicalDepthStatus(student.report_score)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Documentation:</span>
                                    <span class="font-medium">${getDocumentationStatus(student.report_score)}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${student.error ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 mr-2"></i>
                                <p class="text-red-700 text-sm font-medium">Error:</p>
                            </div>
                            <p class="text-red-600 text-sm mt-1">${student.error}</p>
                        </div>
                    ` : ''}
                `;

                studentReports.appendChild(reportCard);
            });

            resultsContainer.classList.remove('hidden');
            lucide.createIcons();
        }

        function formatAIFeedback(feedback) {
            if (!feedback) return '<p class="text-gray-500 italic">No AI feedback available</p>';

            // Convert markdown-style formatting to HTML
            return feedback
                .replace(/^## (.*$)/gm, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>')
                .replace(/^### (.*$)/gm, '<h4 class="text-md font-medium text-gray-700 mt-3 mb-2">$1</h4>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
                .replace(/^\* (.*$)/gm, '<li class="ml-4">‚Ä¢ $1</li>')
                .replace(/\n\n/g, '</p><p class="mb-3">')
                .replace(/\n/g, '<br>');
        }

        function getImplementationStatus(score) {
            if (score >= 0.8) return '‚úÖ Excellent';
            if (score >= 0.6) return '‚úÖ Good';
            if (score >= 0.4) return '‚ö†Ô∏è Fair';
            return '‚ùå Needs Improvement';
        }

        function getStructureStatus(score) {
            if (score >= 0.8) return '‚úÖ Well Structured';
            if (score >= 0.6) return '‚úÖ Organized';
            if (score >= 0.4) return '‚ö†Ô∏è Basic Structure';
            return '‚ùå Poor Structure';
        }

        function getAlgorithmStatus(score) {
            if (score >= 0.8) return '‚úÖ Correct Logic';
            if (score >= 0.6) return '‚úÖ Mostly Correct';
            if (score >= 0.4) return '‚ö†Ô∏è Partial Implementation';
            return '‚ùå Incomplete';
        }

        function getReportStructureStatus(score) {
            if (score >= 0.8) return '‚úÖ Well Organized';
            if (score >= 0.6) return '‚úÖ Good Structure';
            if (score >= 0.4) return '‚ö†Ô∏è Basic Organization';
            return '‚ùå Poor Structure';
        }

        function getTechnicalDepthStatus(score) {
            if (score >= 0.8) return '‚úÖ In-depth Analysis';
            if (score >= 0.6) return '‚úÖ Good Technical Content';
            if (score >= 0.4) return '‚ö†Ô∏è Basic Technical Info';
            return '‚ùå Limited Technical Depth';
        }

        function getDocumentationStatus(score) {
            if (score >= 0.8) return '‚úÖ Comprehensive';
            if (score >= 0.6) return '‚úÖ Well Documented';
            if (score >= 0.4) return '‚ö†Ô∏è Some Documentation';
            return '‚ùå Minimal Documentation';
        }

        function getTestCasesStatus(score) {
            if (score >= 0.8) return '‚úÖ All Passed';
            if (score >= 0.6) return '‚úÖ Most Passed';
            if (score >= 0.4) return '‚ö†Ô∏è Some Passed';
            return '‚ùå Few Passed';
        }

        function getCodeQualityStatus(score) {
            if (score >= 0.8) return '‚úÖ Excellent';
            if (score >= 0.6) return '‚úÖ Good';
            if (score >= 0.4) return '‚ö†Ô∏è Fair';
            return '‚ùå Needs Improvement';
        }

        function getBestPracticesStatus(score) {
            if (score >= 0.8) return '‚úÖ Followed';
            if (score >= 0.6) return '‚úÖ Mostly Followed';
            if (score >= 0.4) return '‚ö†Ô∏è Partially Followed';
            return '‚ùå Not Followed';
        }

        function getReadabilityStatus(score) {
            if (score >= 0.8) return '‚úÖ Highly Readable';
            if (score >= 0.6) return '‚úÖ Readable';
            if (score >= 0.4) return '‚ö†Ô∏è Somewhat Readable';
            return '‚ùå Hard to Read';
        }

        function toggleSettings() {
            const isHidden = settingsPanel.classList.contains('hidden');
            if (isHidden) {
                settingsPanel.classList.remove('hidden');
            } else {
                settingsPanel.classList.add('hidden');
            }
        }

        function updateWeightDisplay() {
            const functional = parseFloat(functionalWeight.value);
            const codeQuality = parseFloat(codeQualityWeight.value);
            const reportQuality = parseFloat(reportQualityWeight.value);

            functionalValue.textContent = Math.round(functional * 100) + '%';
            codeQualityValue.textContent = Math.round(codeQuality * 100) + '%';
            reportValue.textContent = Math.round(reportQuality * 100) + '%';

            const total = functional + codeQuality + reportQuality;
            totalWeight.textContent = Math.round(total * 100) + '%';

            if (Math.abs(total - 1.0) > 0.01) {
                weightWarning.classList.remove('hidden');
                saveSettings.disabled = true;
            } else {
                weightWarning.classList.add('hidden');
                saveSettings.disabled = false;
            }
        }

        async function saveSettingsToServer() {
            const starterCode = starterCodeText.value.trim();
            const settings = {
                functional_tests: parseFloat(functionalWeight.value),
                code_quality: parseFloat(codeQualityWeight.value),
                report_quality: parseFloat(reportQualityWeight.value),
                starter_code: starterCode
            };

            try {
                const response = await fetch('http://127.0.0.1:5001/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                alert('Settings saved successfully!');
                settingsPanel.classList.add('hidden');

            } catch (error) {
                console.error('Settings save error:', error);
                alert('Failed to save settings: ' + error.message);
            }
        }

        async function resetSettingsToDefault() {
            functionalWeight.value = 0.4;
            codeQualityWeight.value = 0.4;
            reportQualityWeight.value = 0.2;
            updateWeightDisplay();

            await saveSettingsToServer();
        }

        async function loadCurrentSettings() {
            try {
                const response = await fetch('http://127.0.0.1:5001/settings');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const settings = await response.json();
                functionalWeight.value = settings.functional_tests;
                codeQualityWeight.value = settings.code_quality;
                reportQualityWeight.value = settings.report_quality;
                updateWeightDisplay();

            } catch (error) {
                console.error('Settings load error:', error);
                // Use default values if loading fails
                updateWeightDisplay();
            }
        }

        function exportData(format) {
            if (!currentJobId) {
                alert('No evaluation data available to export');
                return;
            }

            if (format === 'csv') {
                exportAsCSV();
            } else if (format === 'json') {
                exportAsJSON();
            }
        }

        function exportAsCSV() {
            // Get the current report data from the page
            const rows = [];
            const tableBody = document.getElementById('overview-table-body');
            const rowsData = tableBody.querySelectorAll('tr');

            // Add header
            rows.push(['Student ID', 'Test Cases (%)', 'Code Quality (%)', 'Report Quality (%)', 'Overall Score (%)', 'Plagiarism (%)', 'AI Feedback']);

            // Add data rows
            rowsData.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const studentId = cells[0].textContent.trim();
                    const testCases = cells[1].textContent.replace('%', '').trim();
                    const codeQuality = cells[2].textContent.replace('%', '').trim();
                    const reportQuality = cells[3].textContent.replace('%', '').trim();
                    const overallScore = cells[4].textContent.replace('%', '').trim();
                    const plagiarism = cells[5].textContent.replace('%', '').trim();

                    rows.push([studentId, testCases, codeQuality, reportQuality, overallScore, plagiarism, 'See detailed analysis']);
                }
            });

            // Convert to CSV
            const csvContent = rows.map(row =>
                row.map(field => `"${field.replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `evaluation_results_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportAsJSON() {
            // Get the full report data by making an API call
            fetch(`http://127.0.0.1:5001/evaluate/results/${currentJobId}`)
                .then(response => response.json())
                .then(data => {
                    const jsonContent = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `evaluation_results_${new Date().toISOString().split('T')[0]}.json`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(error => {
                    console.error('Export error:', error);
                    alert('Failed to export JSON data');
                });
        }

        function showPlagiarismDetails(studentId, encodedData) {
            let plagiarismDetails;
            try {
                // Decode the base64 encoded JSON data
                plagiarismDetails = JSON.parse(atob(encodedData));
            } catch (error) {
                console.error('Failed to decode plagiarism data:', error);
                alert('Failed to load plagiarism details');
                return;
            }

            // Create enhanced modal for plagiarism details
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                    <div class="p-6 border-b border-gray-200 flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="p-2 bg-red-100 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">üîç Academic Integrity Analysis</h3>
                                    <p class="text-sm text-gray-600">Student: <span class="font-medium">${studentId}</span></p>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-6 overflow-y-auto flex-1 min-h-0">
                        ${plagiarismDetails.length > 0 ? `
                            <div class="mb-6">
                                <div class="flex items-center space-x-2 mb-4">
                                    <i data-lucide="file-x" class="w-5 h-5 text-red-500"></i>
                                    <h4 class="text-lg font-semibold text-gray-800">Potential Academic Integrity Concerns</h4>
                                </div>
                                <p class="text-gray-600 mb-4">
                                    The following submissions show significant code similarities. Please review carefully and consider the context of each submission.
                                </p>
                            </div>

                            <div class="space-y-4">
                                ${plagiarismDetails.map((detail, index) => {
                                    const severityColor = detail.severity === 'critical' ? 'red' :
                                                        detail.severity === 'high' ? 'orange' : 'yellow';
                                    const severityIcon = detail.severity === 'critical' ? 'alert-triangle' :
                                                       detail.severity === 'high' ? 'alert-circle' : 'info';

                                    return `
                                        <div class="border border-${severityColor}-200 rounded-lg overflow-hidden">
                                            <div class="bg-${severityColor}-50 px-4 py-3 border-b border-${severityColor}-200">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center space-x-3">
                                                        <div class="p-1 bg-${severityColor}-100 rounded">
                                                            <i data-lucide="${severityIcon}" class="w-4 h-4 text-${severityColor}-600"></i>
                                                        </div>
                                                        <div>
                                                            <span class="font-semibold text-gray-800">${detail.student_id}</span>
                                                            <span class="ml-2 text-sm text-gray-600">‚Ä¢ ${detail.similarity}% similarity</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <span class="px-2 py-1 text-xs font-medium bg-${severityColor}-100 text-${severityColor}-800 rounded-full capitalize">
                                                            ${detail.severity} Risk
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="p-4">
                                                <div class="mb-3">
                                                    <p class="text-sm text-gray-700 mb-2">
                                                        <strong>Analysis:</strong> ${detail.reason}
                                                    </p>
                                                    ${detail.analysis ? `
                                                        <p class="text-sm text-gray-600">
                                                            <strong>Details:</strong> ${detail.analysis}
                                                        </p>
                                                    ` : ''}
                                                </div>

                                                ${detail.similar_code_blocks && detail.similar_code_blocks.length > 0 ? `
                                                    <div class="mt-4">
                                                        <div class="flex items-center space-x-2 mb-3">
                                                            <i data-lucide="code" class="w-4 h-4 text-gray-500"></i>
                                                            <span class="text-sm font-medium text-gray-700">Similar Code Segments</span>
                                                        </div>
                                                        <div class="space-y-3">
                                                            ${detail.similar_code_blocks.map((block, blockIndex) => `
                                                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                                                    <div class="flex items-center justify-between mb-2">
                                                                        <span class="text-xs font-medium text-gray-600">Segment ${blockIndex + 1}</span>
                                                                        <button onclick="copyToClipboard(this.nextElementSibling)" class="text-xs text-blue-600 hover:text-blue-800 flex items-center space-x-1">
                                                                            <i data-lucide="copy" class="w-3 h-3"></i>
                                                                            <span>Copy</span>
                                                                        </button>
                                                                    </div>
                                                                    <pre class="text-xs text-gray-800 whitespace-pre-wrap font-mono bg-white p-2 rounded border overflow-x-auto">${block.replace(/</g, '<').replace(/>/g, '>')}</pre>
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    </div>
                                                ` : ''}

                                                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                                    <div class="flex items-start space-x-2">
                                                        <i data-lucide="lightbulb" class="w-4 h-4 text-blue-600 mt-0.5"></i>
                                                        <div class="text-sm text-blue-800">
                                                            <strong>Recommendation:</strong> Compare submission files directly and consider interviewing students about their implementation approach.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-12">
                                <div class="p-4 bg-green-100 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                                    <i data-lucide="check-circle" class="w-8 h-8 text-green-600"></i>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">No Significant Similarities Detected</h4>
                                <p class="text-gray-600">
                                    This submission does not show concerning levels of similarity with other submissions in the batch.
                                </p>
                            </div>
                        `}

                        <div class="mt-8 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <div class="flex items-start space-x-3">
                                <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                                <div class="text-sm text-gray-700">
                                    <strong>About this analysis:</strong> Similarity detection uses AST parsing and structural comparison to identify potential academic integrity concerns. This analysis should be used as a starting point for manual review, not as final determination.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Close
                        </button>
                        <button onclick="window.print()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                            <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                            Print Report
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            lucide.createIcons();
        }

        function copyToClipboard(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                // Show temporary success feedback
                const originalText = element.previousElementSibling.textContent;
                element.previousElementSibling.textContent = 'Copied!';
                setTimeout(() => {
                    element.previousElementSibling.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }

        function handleStarterCodeFile(e) {
            const file = e.target.files[0];
            if (file) {
                starterFileName.textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    starterCodeText.value = content;
                    updateStarterCodePreview(content);
                };
                reader.readAsText(file);
            }
        }

        function handleStarterCodeText(e) {
            const content = e.target.value;
            updateStarterCodePreview(content);
        }

        function updateStarterCodePreview(content) {
            if (content.trim()) {
                starterCodeContent.textContent = content;
                starterCodePreview.classList.remove('hidden');
            } else {
                starterCodePreview.classList.add('hidden');
            }
        }

        function clearStarterCode() {
            starterCodeFile.value = '';
            starterCodeText.value = '';
            starterFileName.textContent = 'No file selected';
            starterCodePreview.classList.add('hidden');
        }

        function resetUI() {
            uploadContainer.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            uploadBtn.disabled = false;
            uploadBtn.textContent = uploadMode === 'individual' ? 'Start Evaluation' : 'Start Batch Evaluation';

            if (uploadMode === 'individual') {
                selectedFiles = [];
                updateFileList();
            } else {
                resetBatchSelection();
            }

            if (pollingInterval) {
                clearTimeout(pollingInterval);
                pollingInterval = null;
            }
            currentJobId = null;
        }
    </script>
</body>
</html>
